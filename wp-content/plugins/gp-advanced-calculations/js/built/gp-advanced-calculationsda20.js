!function(){"use strict";var t="INUMBER",e="IOP1",s="IOP2",r="IOP3",n="IVAR",i="IVARNAME",o="IFUNCALL",a="IFUNDEF",p="IEXPR",h="IEXPREVAL",u="IMEMBER",l="IENDSTATEMENT",c="IARRAY";function f(t,e){this.type=t,this.value=null!=e?e:0}function v(t){return new f(e,t)}function d(t){return new f(s,t)}function y(t){return new f(r,t)}function g(o,a,h,l,v){for(var d,y,m,w,x=[],b=[],M=0;M<o.length;M++){var A=o[M],E=A.type;if(E===t||E===i)Array.isArray(A.value)?x.push.apply(x,g(A.value.map((function(e){return new f(t,e)})).concat(new f(c,A.value.length)),a,h,l,v)):x.push(A);else if(E===n&&v.hasOwnProperty(A.value))A=new f(t,v[A.value]),x.push(A);else if(E===s&&x.length>1)y=x.pop(),d=x.pop(),w=h[A.value],A=new f(t,w(d.value,y.value)),x.push(A);else if(E===r&&x.length>2)m=x.pop(),y=x.pop(),d=x.pop(),"?"===A.value?x.push(d.value?y.value:m.value):(w=l[A.value],A=new f(t,w(d.value,y.value,m.value)),x.push(A));else if(E===e&&x.length>0)d=x.pop(),w=a[A.value],A=new f(t,w(d.value)),x.push(A);else if(E===p){for(;x.length>0;)b.push(x.shift());b.push(new f(p,g(A.value,a,h,l,v)))}else if(E===u&&x.length>0)d=x.pop(),x.push(new f(t,d.value[A.value]));else{for(;x.length>0;)b.push(x.shift());b.push(A)}}for(;x.length>0;)b.push(x.shift());return b}function m(t,i,o){for(var a=[],h=0;h<t.length;h++){var u=t[h],l=u.type;if(l===n&&u.value===i)for(var c=0;c<o.tokens.length;c++){var g,w=o.tokens[c];g=w.type===e?v(w.value):w.type===s?d(w.value):w.type===r?y(w.value):new f(w.type,w.value),a.push(g)}else l===p?a.push(new f(p,m(u.value,i,o))):a.push(u)}return a}function w(f,v,d){var y,g,m,A,E,k,O=[];if(b(f))return M(f,d);for(var T=f.length,_=0;_<T;_++){var F=f[_],C=F.type;if(C===t||C===i)O.push(F.value);else if(C===s)g=O.pop(),y=O.pop(),"and"===F.value?O.push(!!y&&!!w(g,v,d)):"or"===F.value?O.push(!!y||!!w(g,v,d)):"="===F.value?(A=v.binaryOps[F.value],O.push(A(y,w(g,v,d),d))):(A=v.binaryOps[F.value],O.push(A(M(y,d),M(g,d))));else if(C===r)m=O.pop(),g=O.pop(),y=O.pop(),"?"===F.value?O.push(w(y?g:m,v,d)):(A=v.ternaryOps[F.value],O.push(A(M(y,d),M(g,d),M(m,d))));else if(C===n)if(F.value in v.functions)O.push(v.functions[F.value]);else if(F.value in v.unaryOps&&v.parser.isOperatorEnabled(F.value))O.push(v.unaryOps[F.value]);else{var I=d[F.value];if(void 0===I)throw new Error("undefined variable: "+F.value);O.push(I)}else if(C===e)y=O.pop(),A=v.unaryOps[F.value],O.push(A(M(y,d)));else if(C===o){for(k=F.value,E=[];k-- >0;)E.unshift(M(O.pop(),d));if(!(A=O.pop()).apply||!A.call)throw new Error(A+" is not a function");O.push(A.apply(void 0,E))}else if(C===a)O.push(function(){for(var t=O.pop(),e=[],s=F.value;s-- >0;)e.unshift(O.pop());var r=O.pop(),n=function(){for(var s=Object.assign({},d),r=0,n=e.length;r<n;r++)s[e[r]]=arguments[r];return w(t,v,s)};return Object.defineProperty(n,"name",{value:r,writable:!1}),d[r]=n,n}());else if(C===p)O.push(x(F,v));else if(C===h)O.push(F);else if(C===u)y=O.pop(),O.push(y[F.value]);else if(C===l)O.pop();else{if(C!==c)throw new Error("invalid Expression");for(k=F.value,E=[];k-- >0;)E.unshift(O.pop());O.push(E)}}if(O.length>1)throw new Error("invalid Expression (parity)");return 0===O[0]?0:M(O[0],d)}function x(t,e,s){return b(t)?t:{type:h,value:function(s){return w(t.value,e,s)}}}function b(t){return t&&t.type===h}function M(t,e){return b(t)?t.value(e):t}function A(h,f){for(var v,d,y,g,m,w,x=[],b=0;b<h.length;b++){var M=h[b],k=M.type;if(k===t)"number"==typeof M.value&&M.value<0?x.push("("+M.value+")"):Array.isArray(M.value)?x.push("["+M.value.map(E).join(", ")+"]"):x.push(E(M.value));else if(k===s)d=x.pop(),v=x.pop(),g=M.value,f?"^"===g?x.push("Math.pow("+v+", "+d+")"):"and"===g?x.push("(!!"+v+" && !!"+d+")"):"or"===g?x.push("(!!"+v+" || !!"+d+")"):"||"===g?x.push("(function(a,b){ return Array.isArray(a) && Array.isArray(b) ? a.concat(b) : String(a) + String(b); }(("+v+"),("+d+")))"):"=="===g?x.push("("+v+" === "+d+")"):"!="===g?x.push("("+v+" !== "+d+")"):"["===g?x.push(v+"[("+d+") | 0]"):x.push("("+v+" "+g+" "+d+")"):"["===g?x.push(v+"["+d+"]"):x.push("("+v+" "+g+" "+d+")");else if(k===r){if(y=x.pop(),d=x.pop(),v=x.pop(),"?"!==(g=M.value))throw new Error("invalid Expression");x.push("("+v+" ? "+d+" : "+y+")")}else if(k===n||k===i)x.push(M.value);else if(k===e)v=x.pop(),"-"===(g=M.value)||"+"===g?x.push("("+g+v+")"):f?"not"===g?x.push("(!"+v+")"):"!"===g?x.push("fac("+v+")"):x.push(g+"("+v+")"):"!"===g?x.push("("+v+"!)"):x.push("("+g+" "+v+")");else if(k===o){for(w=M.value,m=[];w-- >0;)m.unshift(x.pop());g=x.pop(),x.push(g+"("+m.join(", ")+")")}else if(k===a){for(d=x.pop(),w=M.value,m=[];w-- >0;)m.unshift(x.pop());v=x.pop(),f?x.push("("+v+" = function("+m.join(", ")+") { return "+d+" })"):x.push("("+v+"("+m.join(", ")+") = "+d+")")}else if(k===u)v=x.pop(),x.push(v+"."+M.value);else if(k===c){for(w=M.value,m=[];w-- >0;)m.unshift(x.pop());x.push("["+m.join(", ")+"]")}else if(k===p)x.push("("+A(M.value,f)+")");else if(k!==l)throw new Error("invalid Expression")}return x.length>1&&(x=f?[x.join(",")]:[x.join(";")]),String(x[0])}function E(t){return"string"==typeof t?JSON.stringify(t).replace(/\u2028/g,"\\u2028").replace(/\u2029/g,"\\u2029"):t}function k(t,e){for(var s=0;s<t.length;s++)if(t[s]===e)return!0;return!1}function O(t,e,s){for(var r=!!(s=s||{}).withMembers,o=null,a=0;a<t.length;a++){var h=t[a];h.type===n||h.type===i?r||k(e,h.value)?null!==o?(k(e,o)||e.push(o),o=h.value):o=h.value:e.push(h.value):h.type===u&&r&&null!==o?o+="."+h.value:h.type===p?O(h.value,e,s):null!==o&&(k(e,o)||e.push(o),o=null)}null===o||k(e,o)||e.push(o)}function T(t,e){this.tokens=t,this.parser=e,this.unaryOps=e.unaryOps,this.binaryOps=e.binaryOps,this.ternaryOps=e.ternaryOps,this.functions=e.functions}f.prototype.toString=function(){switch(this.type){case t:case e:case s:case r:case n:case i:case l:return this.value;case o:return"CALL "+this.value;case a:return"DEF "+this.value;case c:return"ARRAY "+this.value;case u:return"."+this.value;default:return"Invalid Instruction"}},T.prototype.simplify=function(t){return t=t||{},new T(g(this.tokens,this.unaryOps,this.binaryOps,this.ternaryOps,t),this.parser)},T.prototype.substitute=function(t,e){return e instanceof T||(e=this.parser.parse(String(e))),new T(m(this.tokens,t,e),this.parser)},T.prototype.evaluate=function(t){return t=t||{},w(this.tokens,this,t)},T.prototype.toString=function(){return A(this.tokens,!1)},T.prototype.symbols=function(t){t=t||{};var e=[];return O(this.tokens,e,t),e},T.prototype.variables=function(t){t=t||{};var e=[];O(this.tokens,e,t);var s=this.functions;return e.filter((function(t){return!(t in s)}))},T.prototype.toJSFunction=function(t,e){var s=this,r=new Function(t,"with(this.functions) with (this.ternaryOps) with (this.binaryOps) with (this.unaryOps) { return "+A(this.simplify(e).tokens,!0)+"; }");return function(){return r.apply(s,arguments)}};var _="TEOF",F="TOP",C="TNUMBER",I="TSTRING",S="TPAREN",N="TBRACKET",j="TCOMMA",P="TNAME",$="TSEMICOLON";function R(t,e,s){this.type=t,this.value=e,this.index=s}function L(t,e){this.pos=0,this.current=null,this.unaryOps=t.unaryOps,this.binaryOps=t.binaryOps,this.ternaryOps=t.ternaryOps,this.consts=t.consts,this.expression=e,this.savedPosition=0,this.savedCurrent=null,this.options=t.options,this.parser=t}R.prototype.toString=function(){return this.type+": "+this.value},L.prototype.newToken=function(t,e,s){return new R(t,e,null!=s?s:this.pos)},L.prototype.save=function(){this.savedPosition=this.pos,this.savedCurrent=this.current},L.prototype.restore=function(){this.pos=this.savedPosition,this.current=this.savedCurrent},L.prototype.next=function(){return this.pos>=this.expression.length?this.newToken(_,"EOF"):this.isWhitespace()||this.isComment()?this.next():this.isRadixInteger()||this.isNumber()||this.isOperator()||this.isString()||this.isParen()||this.isBracket()||this.isComma()||this.isSemicolon()||this.isNamedOp()||this.isConst()||this.isName()?this.current:void this.parseError('Unknown character "'+this.expression.charAt(this.pos)+'"')},L.prototype.isString=function(){var t=!1,e=this.pos,s=this.expression.charAt(e);if("'"===s||'"'===s)for(var r=this.expression.indexOf(s,e+1);r>=0&&this.pos<this.expression.length;){if(this.pos=r+1,"\\"!==this.expression.charAt(r-1)){var n=this.expression.substring(e+1,r);this.current=this.newToken(I,this.unescape(n),e),t=!0;break}r=this.expression.indexOf(s,r+1)}return t},L.prototype.isParen=function(){var t=this.expression.charAt(this.pos);return("("===t||")"===t)&&(this.current=this.newToken(S,t),this.pos++,!0)},L.prototype.isBracket=function(){var t=this.expression.charAt(this.pos);return!("["!==t&&"]"!==t||!this.isOperatorEnabled("[")||(this.current=this.newToken(N,t),this.pos++,0))},L.prototype.isComma=function(){return","===this.expression.charAt(this.pos)&&(this.current=this.newToken(j,","),this.pos++,!0)},L.prototype.isSemicolon=function(){return";"===this.expression.charAt(this.pos)&&(this.current=this.newToken($,";"),this.pos++,!0)},L.prototype.isConst=function(){for(var t=this.pos,e=t;e<this.expression.length;e++){var s=this.expression.charAt(e);if(s.toUpperCase()===s.toLowerCase()&&(e===this.pos||"_"!==s&&"."!==s&&(s<"0"||s>"9")))break}if(e>t){var r=this.expression.substring(t,e);if(r in this.consts)return this.current=this.newToken(C,this.consts[r]),this.pos+=r.length,!0}return!1},L.prototype.isNamedOp=function(){for(var t=this.pos,e=t;e<this.expression.length;e++){var s=this.expression.charAt(e);if(s.toUpperCase()===s.toLowerCase()&&(e===this.pos||"_"!==s&&(s<"0"||s>"9")))break}if(e>t){var r=this.expression.substring(t,e);if(this.isOperatorEnabled(r)&&(r in this.binaryOps||r in this.unaryOps||r in this.ternaryOps))return this.current=this.newToken(F,r),this.pos+=r.length,!0}return!1},L.prototype.isName=function(){for(var t=this.pos,e=t,s=!1;e<this.expression.length;e++){var r=this.expression.charAt(e);if(r.toUpperCase()===r.toLowerCase()){if(e===this.pos&&("$"===r||"_"===r)){"_"===r&&(s=!0);continue}if(e===this.pos||!s||"_"!==r&&(r<"0"||r>"9"))break}else s=!0}if(s){var n=this.expression.substring(t,e);return this.current=this.newToken(P,n),this.pos+=n.length,!0}return!1},L.prototype.isWhitespace=function(){for(var t=!1,e=this.expression.charAt(this.pos);!(" "!==e&&"\t"!==e&&"\n"!==e&&"\r"!==e||(t=!0,this.pos++,this.pos>=this.expression.length));)e=this.expression.charAt(this.pos);return t};var U=/^[0-9a-f]{4}$/i;function Q(t,e,s){this.parser=t,this.tokens=e,this.current=null,this.nextToken=null,this.next(),this.savedCurrent=null,this.savedNextToken=null,this.allowMemberAccess=!1!==s.allowMemberAccess}L.prototype.unescape=function(t){var e=t.indexOf("\\");if(e<0)return t;for(var s=t.substring(0,e);e>=0;){var r=t.charAt(++e);switch(r){case"'":s+="'";break;case'"':s+='"';break;case"\\":s+="\\";break;case"/":s+="/";break;case"b":s+="\b";break;case"f":s+="\f";break;case"n":s+="\n";break;case"r":s+="\r";break;case"t":s+="\t";break;case"u":var n=t.substring(e+1,e+5);U.test(n)||this.parseError("Illegal escape sequence: \\u"+n),s+=String.fromCharCode(parseInt(n,16)),e+=4;break;default:throw this.parseError('Illegal escape sequence: "\\'+r+'"')}++e;var i=t.indexOf("\\",e);s+=t.substring(e,i<0?t.length:i),e=i}return s},L.prototype.isComment=function(){return"/"===this.expression.charAt(this.pos)&&"*"===this.expression.charAt(this.pos+1)&&(this.pos=this.expression.indexOf("*/",this.pos)+2,1===this.pos&&(this.pos=this.expression.length),!0)},L.prototype.isRadixInteger=function(){var t,e,s=this.pos;if(s>=this.expression.length-2||"0"!==this.expression.charAt(s))return!1;if(++s,"x"===this.expression.charAt(s))t=16,e=/^[0-9a-f]$/i,++s;else{if("b"!==this.expression.charAt(s))return!1;t=2,e=/^[01]$/i,++s}for(var r=!1,n=s;s<this.expression.length;){var i=this.expression.charAt(s);if(!e.test(i))break;s++,r=!0}return r&&(this.current=this.newToken(C,parseInt(this.expression.substring(n,s),t)),this.pos=s),r},L.prototype.isNumber=function(){for(var t,e=!1,s=this.pos,r=s,n=s,i=!1,o=!1;s<this.expression.length&&((t=this.expression.charAt(s))>="0"&&t<="9"||!i&&"."===t);)"."===t?i=!0:o=!0,s++,e=o;if(e&&(n=s),"e"===t||"E"===t){s++;for(var a=!0,p=!1;s<this.expression.length;){if(t=this.expression.charAt(s),!a||"+"!==t&&"-"!==t){if(!(t>="0"&&t<="9"))break;p=!0,a=!1}else a=!1;s++}p||(s=n)}return e?(this.current=this.newToken(C,parseFloat(this.expression.substring(r,s))),this.pos=s):this.pos=n,e},L.prototype.isOperator=function(){var t=this.pos,e=this.expression.charAt(this.pos);if("+"===e||"-"===e||"*"===e||"/"===e||"%"===e||"^"===e||"?"===e||":"===e||"."===e)this.current=this.newToken(F,e);else if("∙"===e||"•"===e)this.current=this.newToken(F,"*");else if(">"===e)"="===this.expression.charAt(this.pos+1)?(this.current=this.newToken(F,">="),this.pos++):this.current=this.newToken(F,">");else if("<"===e)"="===this.expression.charAt(this.pos+1)?(this.current=this.newToken(F,"<="),this.pos++):this.current=this.newToken(F,"<");else if("|"===e){if("|"!==this.expression.charAt(this.pos+1))return!1;this.current=this.newToken(F,"||"),this.pos++}else if("="===e)"="===this.expression.charAt(this.pos+1)?(this.current=this.newToken(F,"=="),this.pos++):this.current=this.newToken(F,e);else{if("!"!==e)return!1;"="===this.expression.charAt(this.pos+1)?(this.current=this.newToken(F,"!="),this.pos++):this.current=this.newToken(F,e)}return this.pos++,!!this.isOperatorEnabled(this.current.value)||(this.pos=t,!1)},L.prototype.isOperatorEnabled=function(t){return this.parser.isOperatorEnabled(t)},L.prototype.getCoordinates=function(){var t,e=0,s=-1;do{e++,t=this.pos-s,s=this.expression.indexOf("\n",s+1)}while(s>=0&&s<this.pos);return{line:e,column:t}},L.prototype.parseError=function(t){var e=this.getCoordinates();throw new Error("parse error ["+e.line+":"+e.column+"]: "+t)},Q.prototype.next=function(){return this.current=this.nextToken,this.nextToken=this.tokens.next()},Q.prototype.tokenMatches=function(t,e){return void 0===e||(Array.isArray(e)?k(e,t.value):"function"==typeof e?e(t):t.value===e)},Q.prototype.save=function(){this.savedCurrent=this.current,this.savedNextToken=this.nextToken,this.tokens.save()},Q.prototype.restore=function(){this.tokens.restore(),this.current=this.savedCurrent,this.nextToken=this.savedNextToken},Q.prototype.accept=function(t,e){return!(this.nextToken.type!==t||!this.tokenMatches(this.nextToken,e)||(this.next(),0))},Q.prototype.expect=function(t,e){if(!this.accept(t,e)){var s=this.tokens.getCoordinates();throw new Error("parse error ["+s.line+":"+s.column+"]: Expected "+(e||t))}},Q.prototype.parseAtom=function(e){var s=this.tokens.unaryOps;if(this.accept(P)||this.accept(F,(function(t){return t.value in s})))e.push(new f(n,this.current.value));else if(this.accept(C))e.push(new f(t,this.current.value));else if(this.accept(I))e.push(new f(t,this.current.value));else if(this.accept(S,"("))this.parseExpression(e),this.expect(S,")");else{if(!this.accept(N,"["))throw new Error("unexpected "+this.nextToken);if(this.accept(N,"]"))e.push(new f(c,0));else{var r=this.parseArrayList(e);e.push(new f(c,r))}}},Q.prototype.parseExpression=function(t){var e=[];this.parseUntilEndStatement(t,e)||(this.parseVariableAssignmentExpression(e),this.parseUntilEndStatement(t,e)||this.pushExpression(t,e))},Q.prototype.pushExpression=function(t,e){for(var s=0,r=e.length;s<r;s++)t.push(e[s])},Q.prototype.parseUntilEndStatement=function(t,e){return!!this.accept($)&&(!this.nextToken||this.nextToken.type===_||this.nextToken.type===S&&")"===this.nextToken.value||e.push(new f(l)),this.nextToken.type!==_&&this.parseExpression(e),t.push(new f(p,e)),!0)},Q.prototype.parseArrayList=function(t){for(var e=0;!this.accept(N,"]");)for(this.parseExpression(t),++e;this.accept(j);)this.parseExpression(t),++e;return e},Q.prototype.parseVariableAssignmentExpression=function(t){for(this.parseConditionalExpression(t);this.accept(F,"=");){var e=t.pop(),s=[],r=t.length-1;if(e.type!==o){if(e.type!==n&&e.type!==u)throw new Error("expected variable for assignment");this.parseVariableAssignmentExpression(s),t.push(new f(i,e.value)),t.push(new f(p,s)),t.push(d("="))}else{if(!this.tokens.isOperatorEnabled("()="))throw new Error("function definition is not permitted");for(var h=0,l=e.value+1;h<l;h++){var c=r-h;t[c].type===n&&(t[c]=new f(i,t[c].value))}this.parseVariableAssignmentExpression(s),t.push(new f(p,s)),t.push(new f(a,e.value))}}},Q.prototype.parseConditionalExpression=function(t){for(this.parseOrExpression(t);this.accept(F,"?");){var e=[],s=[];this.parseConditionalExpression(e),this.expect(F,":"),this.parseConditionalExpression(s),t.push(new f(p,e)),t.push(new f(p,s)),t.push(y("?"))}},Q.prototype.parseOrExpression=function(t){for(this.parseAndExpression(t);this.accept(F,"or");){var e=[];this.parseAndExpression(e),t.push(new f(p,e)),t.push(d("or"))}},Q.prototype.parseAndExpression=function(t){for(this.parseComparison(t);this.accept(F,"and");){var e=[];this.parseComparison(e),t.push(new f(p,e)),t.push(d("and"))}};var D=["==","!=","<","<=",">=",">","in"];Q.prototype.parseComparison=function(t){for(this.parseAddSub(t);this.accept(F,D);){var e=this.current;this.parseAddSub(t),t.push(d(e.value))}};var q=["+","-","||"];Q.prototype.parseAddSub=function(t){for(this.parseTerm(t);this.accept(F,q);){var e=this.current;this.parseTerm(t),t.push(d(e.value))}};var V=["*","/","%"];function G(t,e){return Number(t)+Number(e)}function B(t,e){return t-e}function J(t,e){return t*e}function z(t,e){return t/e}function Z(t,e){return t%e}function W(t,e){return Array.isArray(t)&&Array.isArray(e)?t.concat(e):""+t+e}function X(t,e){return t===e}function Y(t,e){return t!==e}function K(t,e){return t>e}function H(t,e){return t<e}function tt(t,e){return t>=e}function et(t,e){return t<=e}function st(t,e){return Boolean(t&&e)}function rt(t,e){return Boolean(t||e)}function nt(t,e){return k(e,t)}function it(t){return(Math.exp(t)-Math.exp(-t))/2}function ot(t){return(Math.exp(t)+Math.exp(-t))/2}function at(t){return t===1/0?1:t===-1/0?-1:(Math.exp(t)-Math.exp(-t))/(Math.exp(t)+Math.exp(-t))}function pt(t){return t===-1/0?t:Math.log(t+Math.sqrt(t*t+1))}function ht(t){return Math.log(t+Math.sqrt(t*t-1))}function ut(t){return Math.log((1+t)/(1-t))/2}function lt(t){return Math.log(t)*Math.LOG10E}function ct(t){return-t}function ft(t){return!t}function vt(t){return t<0?Math.ceil(t):Math.floor(t)}function dt(t){return Math.random()*(t||1)}function yt(t){return wt(t+1)}Q.prototype.parseTerm=function(t){for(this.parseFactor(t);this.accept(F,V);){var e=this.current;this.parseFactor(t),t.push(d(e.value))}},Q.prototype.parseFactor=function(t){var e=this.tokens.unaryOps;if(this.save(),this.accept(F,(function(t){return t.value in e}))){if("-"!==this.current.value&&"+"!==this.current.value){if(this.nextToken.type===S&&"("===this.nextToken.value)return this.restore(),void this.parseExponential(t);if(this.nextToken.type===$||this.nextToken.type===j||this.nextToken.type===_||this.nextToken.type===S&&")"===this.nextToken.value)return this.restore(),void this.parseAtom(t)}var s=this.current;this.parseFactor(t),t.push(v(s.value))}else this.parseExponential(t)},Q.prototype.parseExponential=function(t){for(this.parsePostfixExpression(t);this.accept(F,"^");)this.parseFactor(t),t.push(d("^"))},Q.prototype.parsePostfixExpression=function(t){for(this.parseFunctionCall(t);this.accept(F,"!");)t.push(v("!"))},Q.prototype.parseFunctionCall=function(t){var e=this.tokens.unaryOps;if(this.accept(F,(function(t){return t.value in e}))){var s=this.current;this.parseAtom(t),t.push(v(s.value))}else for(this.parseMemberExpression(t);this.accept(S,"(");)if(this.accept(S,")"))t.push(new f(o,0));else{var r=this.parseArgumentList(t);t.push(new f(o,r))}},Q.prototype.parseArgumentList=function(t){for(var e=0;!this.accept(S,")");)for(this.parseExpression(t),++e;this.accept(j);)this.parseExpression(t),++e;return e},Q.prototype.parseMemberExpression=function(t){for(this.parseAtom(t);this.accept(F,".")||this.accept(N,"[");){var e=this.current;if("."===e.value){if(!this.allowMemberAccess)throw new Error('unexpected ".", member access is not permitted');this.expect(P),t.push(new f(u,this.current.value))}else{if("["!==e.value)throw new Error("unexpected symbol: "+e.value);if(!this.tokens.isOperatorEnabled("["))throw new Error('unexpected "[]", arrays are disabled');this.parseExpression(t),this.expect(N,"]"),t.push(d("["))}}};var gt=4.7421875,mt=[.9999999999999971,57.15623566586292,-59.59796035547549,14.136097974741746,-.4919138160976202,3399464998481189e-20,4652362892704858e-20,-9837447530487956e-20,.0001580887032249125,-.00021026444172410488,.00021743961811521265,-.0001643181065367639,8441822398385275e-20,-26190838401581408e-21,36899182659531625e-22];function wt(t){var e,s;if(function(t){return isFinite(t)&&t===Math.round(t)}(t)){if(t<=0)return isFinite(t)?1/0:NaN;if(t>171)return 1/0;for(var r=t-2,n=t-1;r>1;)n*=r,r--;return 0===n&&(n=1),n}if(t<.5)return Math.PI/(Math.sin(Math.PI*t)*wt(1-t));if(t>=171.35)return 1/0;if(t>85){var i=t*t,o=i*t,a=o*t,p=a*t;return Math.sqrt(2*Math.PI/t)*Math.pow(t/Math.E,t)*(1+1/(12*t)+1/(288*i)-139/(51840*o)-571/(2488320*a)+163879/(209018880*p)+5246819/(75246796800*p*t))}--t,s=mt[0];for(var h=1;h<mt.length;++h)s+=mt[h]/(t+h);return e=t+gt+.5,Math.sqrt(2*Math.PI)*Math.pow(e,t+.5)*Math.exp(-e)*s}function xt(t){return Array.isArray(t)?t.length:String(t).length}function bt(){for(var t=0,e=0,s=0;s<arguments.length;s++){var r,n=Math.abs(arguments[s]);e<n?(t=t*(r=e/n)*r+1,e=n):t+=n>0?(r=n/e)*r:n}return e===1/0?1/0:e*Math.sqrt(t)}function Mt(t,e,s){return t?e:s}function At(t,e){return void 0===e||0==+e?Math.round(t):(t=+t,e=-+e,isNaN(t)||"number"!=typeof e||e%1!=0?NaN:(t=t.toString().split("e"),+((t=(t=Math.round(+(t[0]+"e"+(t[1]?+t[1]-e:-e)))).toString().split("e"))[0]+"e"+(t[1]?+t[1]+e:e))))}function Et(t,e,s){return s&&(s[t]=e),e}function kt(t,e){return t[0|e]}function Ot(t){return 1===arguments.length&&Array.isArray(t)?Math.max.apply(Math,t):Math.max.apply(Math,arguments)}function Tt(t){return 1===arguments.length&&Array.isArray(t)?Math.min.apply(Math,t):Math.min.apply(Math,arguments)}function _t(t,e){if("function"!=typeof t)throw new Error("First argument to map is not a function");if(!Array.isArray(e))throw new Error("Second argument to map is not an array");return e.map((function(e,s){return t(e,s)}))}function Ft(t,e,s){if("function"!=typeof t)throw new Error("First argument to fold is not a function");if(!Array.isArray(s))throw new Error("Second argument to fold is not an array");return s.reduce((function(e,s,r){return t(e,s,r)}),e)}function Ct(t,e){if("function"!=typeof t)throw new Error("First argument to filter is not a function");if(!Array.isArray(e))throw new Error("Second argument to filter is not an array");return e.filter((function(e,s){return t(e,s)}))}function It(t,e){if(!Array.isArray(e)&&"string"!=typeof e)throw new Error("Second argument to indexOf is not a string or array");return e.indexOf(t)}function St(t,e){if(!Array.isArray(e))throw new Error("Second argument to join is not an array");return e.join(t)}function Nt(t){return(t>0)-(t<0)||+t}var jt=1/3;function Pt(t){return t<0?-Math.pow(-t,jt):Math.pow(t,jt)}function $t(t){return Math.exp(t)-1}function Rt(t){return Math.log(1+t)}function Lt(t){return Math.log(t)/Math.LN2}function Ut(t){this.options=t||{},this.unaryOps={sin:Math.sin,cos:Math.cos,tan:Math.tan,asin:Math.asin,acos:Math.acos,atan:Math.atan,sinh:Math.sinh||it,cosh:Math.cosh||ot,tanh:Math.tanh||at,asinh:Math.asinh||pt,acosh:Math.acosh||ht,atanh:Math.atanh||ut,sqrt:Math.sqrt,cbrt:Math.cbrt||Pt,log:Math.log,log2:Math.log2||Lt,ln:Math.log,lg:Math.log10||lt,log10:Math.log10||lt,expm1:Math.expm1||$t,log1p:Math.log1p||Rt,abs:Math.abs,ceil:Math.ceil,floor:Math.floor,round:Math.round,trunc:Math.trunc||vt,"-":ct,"+":Number,exp:Math.exp,not:ft,length:xt,"!":yt,sign:Math.sign||Nt},this.binaryOps={"+":G,"-":B,"*":J,"/":z,"%":Z,"^":Math.pow,"||":W,"==":X,"!=":Y,">":K,"<":H,">=":tt,"<=":et,and:st,or:rt,in:nt,"=":Et,"[":kt},this.ternaryOps={"?":Mt},this.functions={random:dt,fac:yt,min:Tt,max:Ot,hypot:Math.hypot||bt,pyt:Math.hypot||bt,pow:Math.pow,atan2:Math.atan2,if:Mt,gamma:wt,roundTo:At,map:_t,fold:Ft,filter:Ct,indexOf:It,join:St},this.consts={E:Math.E,PI:Math.PI,true:!0,false:!1}}Ut.prototype.parse=function(t){var e=[],s=new Q(this,new L(this,t),{allowMemberAccess:this.options.allowMemberAccess});return s.parseExpression(e),s.expect(_,"EOF"),new T(e,this)},Ut.prototype.evaluate=function(t,e){return this.parse(t).evaluate(e)};var Qt=new Ut;Ut.parse=function(t){return Qt.parse(t)},Ut.evaluate=function(t,e){return Qt.parse(t).evaluate(e)};var Dt={"+":"add","-":"subtract","*":"multiply","/":"divide","%":"remainder","^":"power","!":"factorial","<":"comparison",">":"comparison","<=":"comparison",">=":"comparison","==":"comparison","!=":"comparison","||":"concatenate",and:"logical",or:"logical",not:"logical","?":"conditional",":":"conditional","=":"assignment","[":"array","()=":"fndef"};Ut.prototype.isOperatorEnabled=function(t){var e=function(t){return Dt.hasOwnProperty(t)?Dt[t]:t}(t),s=this.options.operators||{};return!(e in s)||!!s[e]};const qt=/F(\d+(?:\.\d+)?)/gm;window.GPAdvancedCalculations=class{constructor({formId:t}){this.pi20DecimalPlaces=3.141592653589793,this.init=()=>{this.setupParser(),window.gform.addFilter("gform_calculation_formula",((t,e,s,r)=>parseInt(s)!==this.formId?t:window.gform.applyFilters("gpac_should_process_calculation",!0,s,e.field_id,t)?(t=this.replaceShorthandVariables(t,e,this.formId),t=this.processConditionals(t,e,this.formId,r),t=this.processExponents(t,e,this.formId,r),t=this.processFunctions(t,e,this.formId,r)):t),15),jQuery(document).trigger("gform_post_conditional_logic"),this.bindShorthandCalcEvents(),this.addGPPAListener()},this.setupParser=()=>{this.parser=new Ut({operators:{add:!0,concatenate:!0,conditional:!0,divide:!0,factorial:!0,multiply:!0,power:!0,remainder:!0,subtract:!0,logical:!0,comparison:!0,in:!1,assignment:!1}}),this.parser.functions={};for(const t in this.parser.unaryOps)-1===["-","+","!"].indexOf(t)&&delete this.parser.unaryOps[t]},this.bindShorthandCalcEvents=()=>{if(!window.gf_global.gfcalc)return;const t=window.gf_global.gfcalc[this.formId],{formulaFields:e,formId:s}=t;for(let r=0;r<e.length;r++){const n=jQuery.extend({},e[r]),i=n.field_id,o=n.formula.match(qt);t.isCalculating[i]=!1;for(const e in o){if(!o.hasOwnProperty(e))continue;const r=o[e].replace(/^F/,""),a=parseInt(r,10),p=jQuery(`#field_${s}_${a}`).find(["input","select","textarea"].map((t=>`${t}[name="input_${r}"]`)).concat(`input[id^="choice_${s}_${r}_"]`).join(", ")),h=`gpacShorthand_${i}`;jQuery(p).off(`.${h}`),"checkbox"===p.prop("type")||"radio"===p.prop("type")?jQuery(p).on(`click.${h}`,(function(){t.bindCalcEvent(r,n,s,0)})):p.is("select")||"hidden"===p.prop("type")?jQuery(p).on(`change.${h}`,(function(){t.bindCalcEvent(r,n,s,0)})):(jQuery(p).on(`change.${h}`,(function(){t.bindCalcEvent(r,n,s,0)})),jQuery(p).on(`keydown.${h}`,(function(){t.bindCalcEvent(r,n,s)}))),window.gform.doAction("gform_post_calculation_events",[o[e],r],n,s,t)}}},this.addGPPAListener=()=>{jQuery(document).on("gppa_updated_batch_fields",((t,e)=>{this.formId==e&&this.bindShorthandCalcEvents()}))},this.processConditionals=(t,e,s,r)=>{let n;const i=/^if\s*\(([\s\S]+?)\)\s*:[\s]+(.+)[\s]+((?:elseif\s*\(.+\)\s*:[\s]+.+[\s]+)*?)else\s*:[\s]+(.+)[\s]+endif\s*;/g,o=/elseif\s*\(([\s\S]+?)\)\s*:[\s]+(.+)/g;let a=t;for(;null!==(n=i.exec(t));){let t;const i=n[0],p=n[3],h=[];if(h.push({tag:"if",condition:this.replaceMergeTags(n[1],e,s),formula:n[2]}),p)for(;null!==(t=o.exec(p));)h.push({tag:"elseif",condition:this.replaceMergeTags(t[1],e,s),formula:t[2]});h.push({tag:"else",condition:null,formula:n[4]}),jQuery.each(h,((t,s)=>{let n=s.condition;if(n&&(n=this.processExponents(n,e,this.formId,r),n=this.processFunctions(n,e,this.formId,r)),"else"===s.tag&&null===s.condition||this.evalFormula(n,e.field_id))return a=a.replace(i,s.formula),!1}))}return a},this.replaceShorthandVariables=(t,e,s)=>{let r;for(;null!==(r=new RegExp(qt).exec(t));){const[n,i]=r;t=t.replace(new RegExp(`${n}(?!d)`),this.replaceMergeTag(i,void 0,e,s))}return t},this.replaceMergeTags=(t,e,s)=>{const r=window.GFMergeTag.parseMergeTags(t);for(const n in r)r.hasOwnProperty(n)&&(t=t.replace(r[n][0],this.replaceMergeTag(r[n][1],r[n][3],e,s)));return this.replaceShorthandVariables(t,e,s)},this.replaceMergeTag=(t,e,s,r)=>{const n=parseInt(t,10);if(void 0===e){const s=jQuery(".gfield_price input[name=input_"+n+"]").is("input[type=radio]"),r=jQuery(".gfield_price select[name=input_"+n+"]").length>0,i=jQuery('.gfield_price input[name="input_'+t+'"]').is("input[type=checkbox]");e=r||s||i?"price":"value"}":choice_label"===e&&(e=void 0);const i=jQuery('.gfield input[name="input_'+t+'"]').closest(".ginput_container_number").length;let o=window.gf_check_field_rule&&"show"!==window.gf_check_field_rule(r,n,!0,"")?0:window.GFMergeTag.getMergeTagValue(r,t,e);const a=window.gf_global.gf_currency_config,p=a.symbol_left||a.symbol_right,h=a.decimal_separator,u=a.thousand_separator,l=new RegExp(`^[0-9\\${h}\\${u}%]+$`),c=new RegExp(`^\\${p}|\\${p} `);let f;return f=!(i||""!==o&&"string"==typeof o&&(o.match(l)||o.match(c))),window.gform.applyFilters("gpac_should_clean_merge_tag_value",!f,o,r,n,s)&&void 0!==window.gf_global.gfcalc[r]&&(o=window.gf_global.gfcalc[r].cleanNumber(o,r,n,s)),f=isNaN(o)||f,f&&(o=JSON.stringify(o)),o},this.processExponents=(t,e,s,r)=>{const n=this.parseFormula(t),i=[];for(;n.length>0;){const t=n.shift();if("operator"!==t.type||"^"!==t.value){i.push(t);continue}const o=t.depth,a=[];for(;i.length>0;){const t=i.pop();if(t.depth===o){0===a.length?a.push(t):i.push(t);break}if(!(t.depth>o)){i.push(t);break}a.push(t)}a.reverse();const p=[];for(;n.length>0;){const t=n.shift();if(t.depth===o){0===p.length?p.push(t):n.unshift(t);break}if(!(t.depth>o)){n.unshift(t);break}p.push(t)}const h=this.evalFormula(this.processFunctions(r.replaceFieldTags(s,this.buildFormula(a),e),e,s,r),e.field_id),u=this.evalFormula(this.processFunctions(r.replaceFieldTags(s,this.buildFormula(p),e),e,s,r),e.field_id);i.push(Object.assign(Object.assign({},t),{type:"value",value:Math.pow(h,u)}))}return this.buildFormula(i)},this.evalFormula=(t,e)=>{try{return t=(t=t.trim()).replace(/&&/g,"and").replace(/\|\|/g,"or"),this.parser.parse(t).evaluate()}catch(s){const r=e?`GP Advanced Calculations: Could not process formula in field ID ${e}. Formula: ${t}`:`GP Advanced Calculations: Could not process formula. Formula: ${t}`;console.warn(r,s)}return 0},this.processFunctions=(t,e,s,r)=>{let n=this.parseFormula(t);if(!n.some((t=>"function"===t.type)))return this.buildFormula(n);let i={abs:Math.abs,average(){return Array.prototype.slice.call(arguments).reduce((function(t,e){return t+e}),0)/arguments.length},ceil:Math.ceil,exp:Math.exp,floor:Math.floor,fv(t,e,s,r,n){void 0===n&&(n=0);const i=Math.pow(1+t,e);let o;return o=t?s*(1+t*n)*(1-i)/t-r*i:-1*(r+s*e),o},ln:Math.log,log:Math.log10,max:Math.max,min:Math.min,pi:()=>this.pi20DecimalPlaces,round:Math.round,sqrt:Math.sqrt,sin:Math.sin,cos:Math.cos,tan:Math.tan,asin:Math.asin,acos:Math.acos,atan:Math.atan};i=window.gform.applyFilters("gpac_functions",i);let o=Math.max(...n.map((t=>t.depth)));t:for(;!(n.every((t=>void 0!==t.processedAtDepth))||o<0);){const t=[];let a;for(let e=0;e<n.length;e++){const s=null==n?void 0:n[e];if(null!=s)if(s.depth>=o&&(!s.processedAtDepth||s.processedAtDepth!==o))t.push(s),n[e]=null,a||(a=e);else if(t.length)break}if(!t.length){o--;continue}if(t.some((t=>"function"===t.type))){const p=[[]];for(const e of t)"function"!==e.type||e.depth!==o?e.depth>o?p[p.length-1].push(Object.assign(Object.assign({},e),{nonFunctionItem:!1})):(1===p[p.length-1].length&&p.push([]),p[p.length-1].length&&p[p.length-1][p[p.length-1].length-1].depth>e.depth&&p.push([]),p[p.length-1].push(Object.assign(Object.assign({},e),{nonFunctionItem:!0,processedAtDepth:o}))):(p.push([]),p[p.length-1].push(e));const h=[];for(const t of p){if(!t.length)continue;if(t.some((t=>t.nonFunctionItem))){h.push(...t);continue}const n=t[0].value.toString().toLowerCase(),a=t.slice(1).map((t=>"value"===t.type?r.replaceFieldTags(s,t.value,e):null)).filter((t=>null!==t)).map(parseFloat);"function"==typeof i[n]&&h.push({processedAtDepth:o,depth:o,type:"value",value:i[n](...a)})}n.splice(a,0,...h),n=n.filter((t=>null!==t));continue}if(!t.some((t=>"operator"===t.type))){t.forEach((t=>{t.processedAtDepth=o})),n.splice(a,0,...t),n=n.filter((t=>null!==t));continue t}const p=[[]];for(const e of t)"sep"===e.type?p.push([]):p[p.length-1].push(e);const h=[];for(const t of p){const n=r.replaceFieldTags(s,this.buildFormula(JSON.parse(JSON.stringify(t)),o),e).trim();h.push({depth:o,processedAtDepth:o,type:"value",value:this.evalFormula(n,e.field_id)})}n.splice(a,0,...h),n=n.filter((t=>null!==t))}return this.buildFormula(n)},this.matchUntil=(t,e,s)=>{let r,n=t.match(s);return n?(n=n[0].length,r=e+t.substr(0,n),t=t.substr(n)):r=e,{formula:t,value:r}},this.parseFormula=t=>{var e,s,r,n;t=t.replace("/s+/g"," ").trim();const i=[];let o=0;for(;t.length>0;){const a=t.substr(0,1);let p,h,u="";switch(t=t.substr(1),!0){case"("===a:o++;break;case")"===a:o--;break;case-1!==jQuery.inArray(a,["*","-","+","/","^","%"]):p={depth:o,type:"operator",value:a};break;case"{"===a:const i=t.indexOf("}");u=a+t.substr(0,i+1),t=t.substr(i+1),p={depth:o,type:"value",value:u};break;case","===a:p={depth:o,type:"sep",value:","};break;case"."===a:case jQuery.isNumeric(a):h=this.matchUntil(t,a,/^[0-9.]+/),t=h.formula,u=h.value,p={depth:o,type:"value",value:u};break;case'"'===a:case"'"===a:h='"'===a?this.matchUntil(t,a,/[^\\]*?"/):this.matchUntil(t,a,/[^\\]*?'/),t=h.formula,u=h.value,p={depth:o,type:"value",value:u};break;case a.match(/[a-zA-Z]/i)&&a.match(/[a-zA-Z]/i).length>0:h=this.matchUntil(t,a,/^[a-zA-Z]+/i),t=h.formula,u=h.value,p={depth:o,type:"function",value:u};break;case(null!==(s=null===(e=a.match(/[<>!=]/))||void 0===e?void 0:e.length)&&void 0!==s?s:0)>0:h=this.matchUntil(t,a,/^=+/),t=h.formula,u=h.value,p={depth:o,type:"comparisonOp",value:" "+u+" "};break;case(null!==(n=null===(r=a.match(/[&|]/))||void 0===r?void 0:r.length)&&void 0!==n?n:0)>0:if(h=this.matchUntil(t,a,/^[&|]+/),t=h.formula,u=h.value,1===u.length)continue;p={depth:o,type:"logicalOp",value:" "+u+" "}}p&&(null==p?void 0:p.value)&&i.push(p)}return i},this.buildFormula=(t,e=0)=>{let s=0,r="";for(let n=0;n<t.length;n++){const i=t[n];i.depth-=e,s<i.depth?(r+="(".repeat(i.depth-s),s=i.depth):s>i.depth&&(r+=")".repeat(s-i.depth),s=i.depth),r+=i.value}return s>0&&(r+=")".repeat(s)),r},this.formId=parseInt(t),this.init()}},String.prototype.repeat=function(t){return new Array(t+1).join(this)}}();
//# sourceMappingURL=gp-advanced-calculations.js.map